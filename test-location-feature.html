<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Feature Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .help-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565c0;
            border-left: 4px solid #2196F3;
        }
        .location-group {
            margin: 20px 0;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input[type="text"], textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            resize: vertical;
            font-family: Arial, sans-serif;
        }
        .btn-location {
            padding: 12px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
            white-space: nowrap;
        }
        .btn-location:hover {
            background: #1976D2;
        }
        .btn-location:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .location-error {
            display: none;
            margin-top: 15px;
        }
        .info-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #ff9800;
        }
        .info-section h3 {
            margin-top: 0;
            color: #e65100;
        }
        .info-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-section li {
            margin: 8px 0;
            color: #666;
        }
        .status-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .status-box h4 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìç Location Feature Test</h1>
        <p class="subtitle">Test the enhanced location capture for Android & iOS</p>
        
        <div class="help-box">
            üìç <strong>Tap the location button</strong> to automatically capture your current location. 
            <br>If prompted, please <strong>allow location access</strong> in your browser/device settings.
        </div>
        
        <div class="location-group">
            <div class="form-row">
                <input type="text" id="latitude" placeholder="Latitude" readonly>
                <input type="text" id="longitude" placeholder="Longitude" readonly>
                <button type="button" class="btn-location" id="fetchLocation" title="Click to get your current location">
                    üìç Get Location
                </button>
            </div>
            <textarea id="locationAddress" rows="3" placeholder="Address will appear here..." readonly></textarea>
            <div class="location-error" id="locationError"></div>
        </div>
        
        <div class="status-box">
            <h4>üìä Status Log:</h4>
            <div id="statusLog">Waiting for location request...</div>
        </div>
        
        <div class="info-section">
            <h3>‚ÑπÔ∏è How It Works</h3>
            <ul>
                <li><strong>First Time:</strong> Browser will ask for location permission</li>
                <li><strong>If Allowed:</strong> Location is captured automatically</li>
                <li><strong>If Denied:</strong> Clear instructions shown to enable it</li>
                <li><strong>Android:</strong> Settings ‚Üí Apps ‚Üí Browser ‚Üí Permissions ‚Üí Location</li>
                <li><strong>iOS:</strong> Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Browser</li>
            </ul>
            
            <h3>üîí Browser Limitations</h3>
            <ul>
                <li>Browsers <strong>cannot</strong> turn on location services automatically (security)</li>
                <li>Browsers <strong>can only</strong> request permission and detect status</li>
                <li>Users <strong>must manually</strong> enable location in device settings if denied</li>
                <li>This is standard behavior across all browsers and platforms</li>
            </ul>
        </div>
    </div>
    
    <script>
        const statusLog = document.getElementById('statusLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            statusLog.innerHTML += `<br>[${timestamp}] ${message}`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }
        
        document.getElementById('fetchLocation').addEventListener('click', fetchLocation);
        
        function fetchLocation() {
            const errorDiv = document.getElementById('locationError');
            const locationBtn = document.getElementById('fetchLocation');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            log('üîç Checking geolocation support...');
            
            if (!navigator.geolocation) {
                log('‚ùå Geolocation not supported');
                showLocationError('‚ùå Geolocation is not supported by your browser', errorDiv);
                return;
            }
            
            log('‚úÖ Geolocation supported');
            locationBtn.textContent = '‚è≥ Getting...';
            locationBtn.disabled = true;
            
            // Check permission state
            if (navigator.permissions && navigator.permissions.query) {
                log('üîê Checking permission state...');
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    log(`üìã Permission state: ${result.state}`);
                    
                    if (result.state === 'denied') {
                        log('üö´ Permission denied by user');
                        showLocationError('üö´ Location permission denied. Please enable location in your device settings:\n\n' +
                            'üì± Android: Settings ‚Üí Apps ‚Üí Browser ‚Üí Permissions ‚Üí Location\n' +
                            'üçé iOS: Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Browser', errorDiv);
                        locationBtn.textContent = 'üìç Get Location';
                        locationBtn.disabled = false;
                        return;
                    }
                    
                    log('‚úÖ Permission OK, requesting location...');
                    getLocationCoordinates(errorDiv, locationBtn);
                }).catch(function(err) {
                    log('‚ö†Ô∏è Permission API error: ' + err.message);
                    getLocationCoordinates(errorDiv, locationBtn);
                });
            } else {
                log('‚ö†Ô∏è Permission API not supported, requesting location...');
                getLocationCoordinates(errorDiv, locationBtn);
            }
        }
        
        function getLocationCoordinates(errorDiv, locationBtn) {
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            log('üì° Requesting GPS coordinates...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    log(`‚úÖ Location received: ${lat.toFixed(6)}, ${long.toFixed(6)}`);
                    log(`üìè Accuracy: ¬±${Math.round(accuracy)} meters`);
                    
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = long.toFixed(6);
                    
                    showLocationSuccess(`‚úÖ Location captured (¬±${Math.round(accuracy)}m accuracy)`, errorDiv);
                    
                    log('üåç Fetching address from coordinates...');
                    
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${long}`, {
                        headers: { 'User-Agent': 'CarInspectionApp/1.0' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            const address = data.display_name || 'Address not found';
                            document.getElementById('locationAddress').value = address;
                            log('‚úÖ Address retrieved successfully');
                            
                            locationBtn.textContent = '‚úì Success';
                            locationBtn.style.background = '#4CAF50';
                            setTimeout(() => {
                                locationBtn.textContent = 'üìç Get Location';
                                locationBtn.style.background = '';
                                locationBtn.disabled = false;
                            }, 2000);
                        })
                        .catch(error => {
                            log('‚ö†Ô∏è Address lookup failed: ' + error.message);
                            document.getElementById('locationAddress').value = `Lat: ${lat}, Long: ${long}`;
                            locationBtn.textContent = 'üìç Get Location';
                            locationBtn.disabled = false;
                        });
                },
                function(error) {
                    let errorMessage = '';
                    
                    log(`‚ùå Location error: ${error.message} (code: ${error.code})`);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            log('üö´ User denied location permission');
                            errorMessage = 'üö´ Location permission denied.\n\n' +
                                'üì± To enable location:\n' +
                                '‚Ä¢ Android: Settings ‚Üí Apps ‚Üí Browser ‚Üí Permissions ‚Üí Location ‚Üí Allow\n' +
                                '‚Ä¢ iOS: Settings ‚Üí Privacy ‚Üí Location Services ‚Üí ON ‚Üí Browser ‚Üí While Using\n\n' +
                                'üîÑ After enabling, tap the üìç button again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            log('üì° Position unavailable');
                            errorMessage = 'üì° Location information unavailable.\n\n' +
                                '‚Ä¢ Make sure you\'re not in airplane mode\n' +
                                '‚Ä¢ Check if Location Services are enabled\n' +
                                '‚Ä¢ Try moving to an area with better signal';
                            break;
                        case error.TIMEOUT:
                            log('‚è±Ô∏è Request timed out');
                            errorMessage = '‚è±Ô∏è Location request timed out.\n\n' +
                                '‚Ä¢ Check your internet connection\n' +
                                '‚Ä¢ Make sure GPS is enabled\n' +
                                '‚Ä¢ Try again in a moment';
                            break;
                        default:
                            log('‚ùå Unknown error');
                            errorMessage = '‚ùå Unable to fetch location.\n\n' +
                                '‚Ä¢ Ensure Location Services are enabled\n' +
                                '‚Ä¢ Check browser permissions\n' +
                                '‚Ä¢ Try refreshing the page';
                    }
                    
                    showLocationError(errorMessage, errorDiv);
                    locationBtn.textContent = 'üìç Get Location';
                    locationBtn.disabled = false;
                },
                options
            );
        }
        
        function showLocationError(message, errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
            errorDiv.style.padding = '15px';
            errorDiv.style.borderRadius = '4px';
            errorDiv.style.marginTop = '10px';
            errorDiv.style.whiteSpace = 'pre-line';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.border = '1px solid #ef5350';
        }
        
        function showLocationSuccess(message, errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#e8f5e9';
            errorDiv.style.color = '#2e7d32';
            errorDiv.style.padding = '10px';
            errorDiv.style.borderRadius = '4px';
            errorDiv.style.marginTop = '10px';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.border = '1px solid #66bb6a';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
        
        // Log initial state
        log('üöÄ Location test page loaded');
        log('üì± Device: ' + navigator.userAgent.match(/Android|iPhone|iPad/i)?.[0] || 'Desktop');
        log('üåê Browser: ' + navigator.userAgent.match(/Chrome|Safari|Firefox|Edge/i)?.[0] || 'Unknown');
    </script>
</body>
</html>
